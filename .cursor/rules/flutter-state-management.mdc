# ğŸ¯ Flutter State Management Rules

## ğŸš¨ Quy táº¯c nghiÃªm ngáº·t

### 1. **Cubit chá»‰ quáº£n lÃ½ State, khÃ´ng chá»©a Business Logic**

```dart
// âŒ SAI - Business logic trong Cubit
class UserCubit extends Cubit<UserState> {
  Future<void> _processUserData() async {
    final userData = await _apiService.getUser();
    final processedData = _processData(userData); // âŒ Business logic
    emit(UserLoaded(user: processedData));
  }
```

```dart
// âœ… ÄÃšNG - Cubit chá»‰ gá»i UseCase
class UserCubit extends Cubit<UserState> {
  final GetUserProfile _getUserProfile;

  UserCubit({required GetUserProfile getUserProfile})
      : _getUserProfile = getUserProfile,
        super(const UserInitial());

  Future<void> loadUserProfile(String userId) async {
    emit(const UserLoading());
    try {
      final user = await _getUserProfile(userId); // âœ… Gá»i UseCase
      emit(UserLoaded(user: user));
    } catch (e) {
      emit(UserError(message: e.toString()));
    }
  }
}
```

### 2. **State pháº£i Immutable vÃ  Extend Equatable**

```dart
// âœ… ÄÃšNG - Immutable state vá»›i Equatable
abstract class UserState extends Equatable {
  const UserState();

  @override
  List<Object?> get props => [];
}

class UserInitial extends UserState {
  const UserInitial();
}

class UserLoading extends UserState {
  const UserLoading();
}

class UserLoaded extends UserState {
  final User user;

  const UserLoaded({required this.user});

  @override
  List<Object?> get props => [user];
}

class UserError extends UserState {
  final String message;

  const UserError({required this.message});

  @override
  List<Object?> get props => [message];
}
```

### 3. **LuÃ´n cÃ³ Loading vÃ  Error States**

```dart
// âœ… ÄÃšNG - Complete state management
abstract class FeatureState extends Equatable {
  const FeatureState();
}

class FeatureInitial extends FeatureState {
  const FeatureInitial();
}

class FeatureLoading extends FeatureState {
  const FeatureLoading();
}

class FeatureLoaded extends FeatureState {
  final List<Data> data;

  const FeatureLoaded({required this.data});

  @override
  List<Object?> get props => [data];
}

class FeatureError extends FeatureState {
  final String message;

  const FeatureError({required this.message});

  @override
  List<Object?> get props => [message];
}
```

## ğŸ“‹ Cáº¥u trÃºc BLoC chuáº©n

```
lib/presentation/bloc/
â”œâ”€â”€ feature_name/
â”‚   â”œâ”€â”€ feature_cubit.dart      # Cubit implementation
â”‚   â””â”€â”€ feature_state.dart      # State classes
â”œâ”€â”€ auth/
â”‚   â”œâ”€â”€ auth_cubit.dart
â”‚   â””â”€â”€ auth_state.dart
â””â”€â”€ user/
    â”œâ”€â”€ user_cubit.dart
    â””â”€â”€ user_state.dart
```

## ğŸ¨ UI Integration vá»›i BLoC

### 1. **BlocBuilder Pattern**

```dart
// âœ… ÄÃšNG - Sá»­ dá»¥ng BlocBuilder
class UserProfileWidget extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return BlocBuilder<UserCubit, UserState>(
      builder: (context, state) {
        return switch (state) {
          UserInitial() => const SizedBox.shrink(),
          UserLoading() => const Center(
              child: CircularProgressIndicator(),
            ),
          UserLoaded() => _buildUserProfile(context, state.user),
          UserError() => Center(
              child: Text('Error: ${state.message}'),
            ),
        };
      },
    );
  }

  Widget _buildUserProfile(BuildContext context, User user) {
    return Card(
      child: ListTile(
        title: Text(user.name),
        subtitle: Text(user.email.value),
      ),
    );
  }
}
```

### 2. **BlocListener cho Side Effects**

```dart
// âœ… ÄÃšNG - Sá»­ dá»¥ng BlocListener cho navigation
class LoginPage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return BlocListener<AuthCubit, AuthState>(
      listener: (context, state) {
        if (state is AuthSuccess) {
          Navigator.pushReplacementNamed(context, '/home');
        } else if (state is AuthError) {
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(content: Text(state.message)),
          );
        }
      },
      child: Scaffold(
        body: BlocBuilder<AuthCubit, AuthState>(
          builder: (context, state) {
            return LoginForm();
          },
        ),
      ),
    );
  }
}
```

### 3. **BlocProvider Setup**

```dart
// âœ… ÄÃšNG - Proper BlocProvider setup
class MyApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MultiBlocProvider(
      providers: [
        BlocProvider<AuthCubit>(
          create: (context) => sl<AuthCubit>(),
        ),
        BlocProvider<UserCubit>(
          create: (context) => sl<UserCubit>(),
        ),
      ],
      child: MaterialApp(
        home: HomePage(),
      ),
    );
  }
}
```

## ğŸ”§ Dependency Injection vá»›i BLoC

```dart
// âœ… ÄÃšNG - Cubit vá»›i dependency injection
@injectable
class UserCubit extends Cubit<UserState> {
  final GetUserProfile _getUserProfile;
  final UpdateUserProfile _updateUserProfile;

  UserCubit({
    required GetUserProfile getUserProfile,
    required UpdateUserProfile updateUserProfile,
  })  : _getUserProfile = getUserProfile,
        _updateUserProfile = updateUserProfile,
        super(const UserInitial());

  Future<void> loadUserProfile(String userId) async {
    emit(const UserLoading());
    try {
      final user = await _getUserProfile(userId);
      emit(UserLoaded(user: user));
    } catch (e) {
      emit(UserError(message: e.toString()));
    }
  }

  Future<void> updateProfile(User user) async {
    emit(const UserUpdating());
    try {
      final updatedUser = await _updateUserProfile(user);
      emit(UserLoaded(user: updatedUser));
    } catch (e) {
      emit(UserError(message: e.toString()));
    }
  }
}
```

## ğŸ” Code Review Checklist

- [ ] **Cubit khÃ´ng chá»©a business logic**
- [ ] **State immutable vÃ  extend Equatable**
- [ ] **CÃ³ Ä‘áº§y Ä‘á»§ Loading vÃ  Error states**
- [ ] **Sá»­ dá»¥ng BlocBuilder/BlocListener Ä‘Ãºng cÃ¡ch**
- [ ] **Dependency injection setup Ä‘Ãºng**

## ğŸ“š References

- [lib/presentation/bloc/](mdc:lib/presentation/bloc/) - State management
- [lib/core/dependency_injection/](mdc:lib/core/dependency_injection/) - DI setup

---
